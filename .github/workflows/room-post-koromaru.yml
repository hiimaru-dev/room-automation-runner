name: room-post-koromaru

concurrency:
  group: room-automation-koromaru
  cancel-in-progress: false

on:
  workflow_dispatch:
  # schedule:
  #  - cron: '30 0 * * *'   # 09:30 JST ãƒ€ã‚¤ã‚¨ãƒƒãƒˆå¥åº·â‘ 
  #   - cron: '30 1 * * *'   # 10:30 JST ãƒ¬ãƒ‡ã‚£ãƒ¼ã‚¹ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³
  #   - cron: '30 2 * * *'   # 11:30 JST ç¾å®¹ã‚³ã‚¹ãƒ¡â‘ 
  #   - cron: '30 4 * * *'   # 13:30 JST ã‚­ãƒƒã‚ºãƒ™ãƒ“ãƒ¼â‘ 
  #   - cron: '30 6 * * *'   # 15:30 JST ãƒ€ã‚¤ã‚¨ãƒƒãƒˆå¥åº·â‘¡
  #   - cron: '30 8 * * *'   # 17:30 JST ã‚­ãƒƒã‚ºãƒ™ãƒ“ãƒ¼â‘¡
  #   - cron: '30 9 * * *'   # 18:30 JST ç¾å®¹ã‚³ã‚¹ãƒ¡â‘¡
  #   - cron: '30 11 * * *'  # 20:30 JST ãƒãƒƒã‚°
  #   - cron: '30 12 * * *'  # 21:30 JST ãƒšãƒƒãƒˆ
  #   - cron: '30 13 * * *'  # 22:30 JST ã‚¹ã‚¤ãƒ¼ãƒ„
  #   - cron: '30 14 * * *'  # 23:30 JST ã‚¤ãƒ³ãƒŠãƒ¼ä¸‹ç€

jobs:
  run-room-post:
    runs-on: ubuntu-latest
    timeout-minutes: 50

    steps:
      - name: Checkout runner repo
        uses: actions/checkout@v4

      - name: Clone private room-automation
        run: |
          git clone https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: room-automation/package-lock.json

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: room-automation/node_modules
          key: ${{ runner.os }}-node-22-${{ hashFiles('room-automation/package-lock.json') }}

      - name: Create .env.koromaru from secret
        run: |
          cd room-automation
          printf '%s\n' "${{ secrets.ENV_KOROMARU }}" > .env.koromaru

      - name: Install dependencies
        run: |
          cd room-automation
          if [ -d node_modules ]; then
            echo "âœ… node_modules cache found â†’ npm install ã‚¹ã‚­ãƒƒãƒ—"
          else
            echo "â¬‡ï¸ node_modules cache ãªã— â†’ npm install å®Ÿè¡Œ"
            npm install
          fi
          
      - name: Cache Puppeteer browser
        id: cache-puppeteer
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('room-automation/package-lock.json') }}

      - name: Install Chrome for Puppeteer (if needed)
        if: steps.cache-puppeteer.outputs.cache-hit != 'true'
        run: |
          cd room-automation
          npx puppeteer browsers install chrome
          
      - name: Run room-post (koromaru / time-based genre)
        run: |
          cd room-automation

          set +e
          npx ts-node -r dotenv/config src/services/room-post/index.ts
          EXIT_CODE=$?

          echo "room-post exited with code ${EXIT_CODE}"

          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "2" ]; then
            echo "room-post failed (exit code=${EXIT_CODE})"
            exit "$EXIT_CODE"
          fi
        env:
          NODE_ENV: production
          DOTENV_CONFIG_PATH: .env.koromaru
          ROOM_TIME_CRON: ${{ github.event.schedule }}  # â˜…è¿½åŠ 

      - name: Commit & push JSON logs
        run: |
          cd room-automation

          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git

          # x-beauty-post ã® tips ç³»
          if ls src/services/x-beauty-post/data/*.json >/dev/null 2>&1; then
            git add src/services/x-beauty-post/data/*.json
          fi

          # last_room_id.json
          if [ -f src/services/room-post/data/last_room_id.json ]; then
            git add src/services/room-post/data/last_room_id.json
          fi

          # posted-hiimaru / posted-koromaru
          if [ -f session/posted-hiimaru.json ]; then
            git add -f session/posted-hiimaru.json
          fi
          if [ -f session/posted-koromaru.json ]; then
            git add -f session/posted-koromaru.json
          fi

          # ğŸ” æš—å·åŒ–ã‚¯ãƒƒã‚­ãƒ¼ï¼ˆhiimaru / koromaru å…±é€šã§æ‹¾ã†ï¼‰
          if ls session/rakuten_cookie_*.enc >/dev/null 2>&1; then
            git add -f session/rakuten_cookie_*.enc
          fi

          # ä½•ã‚‚å¤‰åŒ–ãŒãªã‘ã‚Œã°çµ‚ã‚ã‚Š
          if git diff --cached --quiet; then
            echo "No JSON/COOKIE changes to commit."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git commit -m "chore: update runtime json logs (koromaru)" || exit 0

          # ğŸ”„ pull --rebase ã—ã¦ã‹ã‚‰ pushï¼ˆæœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
          for i in 1 2 3; do
            echo "Attempt #$i: pull --rebase & push..."

            # ãƒªãƒ¢ãƒ¼ãƒˆãŒé€²ã‚“ã§ã„ã¦ã‚‚ã€ã¨ã‚Šã‚ãˆãšæœ€æ–°ã‚’å–ã‚Šè¾¼ã‚€
            git pull --rebase origin main || true

            if git push origin HEAD:main; then
              echo "âœ… Push success."
              exit 0
            fi

            echo "âš ï¸ Push failed. Retry after 5 seconds..."
            sleep 5
          done

          echo "âŒ Failed to push after 3 attempts."
          exit 1
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
