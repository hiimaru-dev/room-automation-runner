name: x-beauty-post-hiimaru

# ä»–ã® JSON push ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«å…±é€šã‚°ãƒ«ãƒ¼ãƒ—ã«å…¥ã‚Œã‚‹
concurrency:
  group: room-automation-hiimaru
  cancel-in-progress: false

on:
  workflow_dispatch:
  # schedule:
    # æ¯æ—¥ 6:00 JST ã«1å›å®Ÿè¡Œ
    # 6:00 JST = å‰æ—¥ 21:00 UTC
    # - cron: "0 21 * * *"

jobs:
  run-x-beauty-post:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      TZ: Asia/Tokyo  # â†â˜… ã“ã‚Œã‚’è¿½åŠ 

    steps:
      # 1) runner ãƒªãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout runner repo
        uses: actions/checkout@v4

      # 2) room-automation private repo ã‚’ clone
      - name: Clone private room-automation
        run: |
          git clone https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      # 3) Node.js 22 + npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: room-automation/package-lock.json

      # 3.5) node_modules ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: room-automation/node_modules
          key: ${{ runner.os }}-node-22-${{ hashFiles('room-automation/package-lock.json') }}

      # 4) .env.hiimaru ã‚’ Secret ã‹ã‚‰ç”Ÿæˆ
      - name: Create .env.hiimaru from secret
        run: |
          cd room-automation
          printf '%s\n' "${{ secrets.ENV_HIIMARU }}" > .env.hiimaru

      # 5) ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          cd room-automation
          if [ -d node_modules ]; then
            echo "âœ… node_modules cache found â†’ npm install ã‚¹ã‚­ãƒƒãƒ—"
          else
            echo "â¬‡ï¸ node_modules cache ãªã— â†’ npm install å®Ÿè¡Œ"
            npm install
          fi

      # 6) X æŠ•ç¨¿ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œ
      - name: Run x-beauty-post (hiimaru)
        run: |
          cd room-automation

          set +e
          echo "â–¶ x-beauty-post START (hiimaru)"
          npx ts-node -r dotenv/config src/services/x-beauty-post/index.ts
          EXIT_CODE=$?

          echo "x-beauty-post exited with code ${EXIT_CODE}"

          # 0, 2 ã‚’æˆåŠŸæ‰±ã„ï¼ˆroom-post ã¨åŒã˜é‹ç”¨ãªã‚‰ï¼‰
          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "2" ]; then
            echo "x-beauty-post failed (exit code=${EXIT_CODE})"
            exit "$EXIT_CODE"
          fi
        env:
          NODE_ENV: production
          DOTENV_CONFIG_PATH: .env.hiimaru

      # 7) X ç”¨ JSON / cookie ãƒ­ã‚°ãªã©ã‚’ commit & push
      - name: Commit & push JSON logs
        run: |
          cd room-automation

          # GitHub Actions ç”¨ã®èªè¨¼ä»˜ããƒªãƒ¢ãƒ¼ãƒˆã‚’è¨­å®š
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git

          # x-beauty-post ã®ãƒ‡ãƒ¼ã‚¿é¡ã‚’è¿½åŠ 
          if ls src/services/x-beauty-post/data/*.json >/dev/null 2>&1; then
            git add src/services/x-beauty-post/data/*.json
          fi

          # å…±æœ‰ã—ã¦ã„ã‚‹ JSON / cookie ã‚‚ã‚ã‚Œã°ä¸€ç·’ã« add
          if [ -f session/posted-hiimaru.json ]; then
            git add -f session/posted-hiimaru.json
          fi
          if [ -f session/posted-koromaru.json ]; then
            git add -f session/posted-koromaru.json
          fi
          if ls session/rakuten_cookie_*.enc >/dev/null 2>&1; then
            git add -f session/rakuten_cookie_*.enc
          fi

          # ä½•ã‚‚å¤‰åŒ–ãŒãªã‘ã‚Œã° commit/push ã›ãšçµ‚äº†
          if git diff --cached --quiet; then
            echo "No JSON/COOKIE changes to commit."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git commit -m "chore: update x-beauty-post json logs (hiimaru)" || exit 0

          # ğŸ”„ pull --rebase ï¼‹ pushï¼ˆæœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
          for i in 1 2 3; do
            echo "Attempt #$i: pull --rebase & push..."

            # é€”ä¸­ã§åˆ¥ã® push ãŒã‚ã£ã¦ã‚‚ã€ã¨ã‚Šã‚ãˆãšæœ€æ–°ã‚’å–ã‚Šè¾¼ã‚€
            git pull --rebase origin main || true

            if git push origin HEAD:main; then
              echo "âœ… Push success."
              exit 0
            fi

            echo "âš ï¸ Push failed. Retry after 5 seconds..."
            sleep 5
          done

          echo "âŒ Failed to push after 3 attempts."
          exit 1
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
