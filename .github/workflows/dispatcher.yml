name: dispatcher

on:
  # cron-job.org から叩くのはこれだけ
  workflow_dispatch:

jobs:
  compute-time-slot:
    runs-on: ubuntu-latest
    outputs:
      time_slot: ${{ steps.time.outputs.time_slot }}
      jst_now: ${{ steps.time.outputs.jst_now }}
    steps:
      - name: Compute JST time slot (30min unit)
        id: time
        run: |
          # ランナーは UTC なので、Asia/Tokyo にして現在時刻を取得
          export TZ=Asia/Tokyo
          H=$(date +'%H')
          M=$(date +'%M')

          # 00〜29分 → :00 スロット、30〜59分 → :30 スロット
          if [ "$M" -lt 30 ]; then
            SLOT_MIN="00"
          else
            SLOT_MIN="30"
          fi

          # 先頭の 0 は削る（"06:00" → "6:00" にしたい）
          H_NOZERO=$(echo "$H" | sed 's/^0//')

          SLOT="${H_NOZERO}:${SLOT_MIN}"

          echo "time_slot=$SLOT" >> "$GITHUB_OUTPUT"
          echo "jst_now=${H}:${M}" >> "$GITHUB_OUTPUT"

          echo "JST now = ${H}:${M}"
          echo "Time slot = ${SLOT}"
          
  dispatch-jobs:
    needs: compute-time-slot
    runs-on: ubuntu-latest
    steps:
      - name: Decide and dispatch workflows
        env:
          SLOT: ${{ needs.compute-time-slot.outputs.time_slot }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Time slot = $SLOT"

          # === 6:00 ===
          if [ "$SLOT" = "6:00" ]; then
            echo "Dispatching for 6:00"
            curl -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -d '{"ref":"main"}' \
              https://api.github.com/repos/hiimaru-dev/room-automation/actions/workflows/x-beauty-post-hiimaru.yml/dispatches

            curl -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -d '{"ref":"main"}' \
              https://api.github.com/repos/hiimaru-dev/room-automation/actions/workflows/auto-follow-koromaru.yml/dispatches

            exit 0
          fi

          # === 6:30 ===
          if [ "$SLOT" = "6:30" ]; then
            echo "Dispatching for 6:30"
            curl -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -d '{"ref":"main"}' \
              https://api.github.com/repos/hiimaru-dev/room-automation/actions/workflows/auto-follow-hiimaru.yml/dispatches

            curl -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -d '{"ref":"main"}' \
              https://api.github.com/repos/hiimaru-dev/room-automation/actions/workflows/auto-like-koromaru.yml/dispatches

            exit 0
          fi

          echo "No job for slot $SLOT"
