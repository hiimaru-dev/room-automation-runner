name: dispatcher

on:
  workflow_dispatch:
  repository_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  compute-time-slot:
    runs-on: ubuntu-latest
    outputs:
      time_slot: ${{ steps.time.outputs.time_slot }}
      jst_now: ${{ steps.time.outputs.jst_now }}
    steps:
      - name: Compute JST time slot (30min unit)
        id: time
        run: |
          export TZ=Asia/Tokyo
          H=$(date +'%H')
          M=$(date +'%M')

          if [ "$M" -lt 30 ]; then
            SLOT_MIN="00"
          else
            SLOT_MIN="30"
          fi

          H_NOZERO=$(echo "$H" | sed 's/^0//')
          SLOT="${H_NOZERO}:${SLOT_MIN}"

          echo "time_slot=$SLOT" >> "$GITHUB_OUTPUT"
          echo "jst_now=${H}:${M}" >> "$GITHUB_OUTPUT"

          echo "JST now = ${H}:${M}"
          echo "Time slot = ${SLOT}"

  dispatch-jobs:
    needs: compute-time-slot
    runs-on: ubuntu-latest
    steps:
      - name: Decide and dispatch workflows
        env:
          SLOT: ${{ needs.compute-time-slot.outputs.time_slot }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: hiimaru-dev/room-automation-runner
        run: |
          echo "Time slot = $SLOT"

          dispatch() {
            local workflow_file="$1"
            local slot_key="$2"
            echo "  -> dispatch $workflow_file (POST_SLOT=$slot_key)"
            curl -sS -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "{\"ref\":\"main\",\"inputs\":{\"POST_SLOT\":\"${slot_key}\"}}" \
              "https://api.github.com/repos/$REPO/actions/workflows/${workflow_file}/dispatches"
          }

          # ============================
          # ここからスケジュール（番号なし）
          # ============================

          # === 6:00 ===
          if [ "$SLOT" = "6:00" ]; then
            dispatch "x-beauty-post-hiimaru.yml"       "HI_X_MORNING"
            dispatch "auto-follow-koromaru.yml"        "KO_FOLLOW"
            exit 0
          fi

          # === 6:30 ===
          if [ "$SLOT" = "6:30" ]; then
            dispatch "auto-follow-hiimaru.yml"         "HI_FOLLOW"
            dispatch "auto-like-koromaru.yml"          "KO_LIKE"
            exit 0
          fi

          # === 7:00 ===
          if [ "$SLOT" = "7:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_BEAUTY"
            dispatch "auto-follow-koromaru.yml"        "KO_FOLLOW"
            exit 0
          fi

          # === 7:30 ===
          if [ "$SLOT" = "7:30" ]; then
            dispatch "auto-like-hiimaru.yml"           "HI_LIKE"
            dispatch "room-post-koromaru.yml"          "KO_BEAUTY"
            exit 0
          fi

          # === 8:00 ===
          if [ "$SLOT" = "8:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_DIET"
            dispatch "auto-follow-koromaru.yml"        "KO_FOLLOW"
            exit 0
          fi

          # === 8:30 ===
          if [ "$SLOT" = "8:30" ]; then
            dispatch "auto-follow-hiimaru.yml"         "HI_FOLLOW"
            dispatch "room-post-koromaru.yml"          "KO_DIET"
            exit 0
          fi

          # === 9:00 ===
          if [ "$SLOT" = "9:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_INNER"
            dispatch "auto-like-koromaru.yml"          "KO_LIKE"
            exit 0
          fi

          # === 9:30 ===
          if [ "$SLOT" = "9:30" ]; then
            dispatch "auto-like-hiimaru.yml"           "HI_LIKE"
            dispatch "room-post-koromaru.yml"          "KO_FASHION"
            exit 0
          fi

          # === 10:00 ===
          if [ "$SLOT" = "10:00" ]; then
            dispatch "auto-like-hiimaru.yml"           "HI_LIKE"
            dispatch "auto-like-koromaru.yml"          "KO_LIKE"
            exit 0
          fi

          # === 10:30 ===
          if [ "$SLOT" = "10:30" ]; then
            dispatch "auto-follow-hiimaru.yml"         "HI_FOLLOW"
            exit 0
          fi

          # === 11:00 ===
          if [ "$SLOT" = "11:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_KIDS"
            dispatch "auto-follow-koromaru.yml"        "KO_FOLLOW"
            exit 0
          fi

          # === 11:30 ===
          if [ "$SLOT" = "11:30" ]; then
            dispatch "auto-follow-hiimaru.yml"         "HI_FOLLOW"
            dispatch "room-post-koromaru.yml"          "KO_KIDS"
            exit 0
          fi

          # === 12:00 ===
          if [ "$SLOT" = "12:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_DRINK"
            dispatch "auto-like-koromaru.yml"          "KO_LIKE"
            exit 0
          fi

          # === 12:30 ===
          if [ "$SLOT" = "12:30" ]; then
            dispatch "auto-like-hiimaru.yml"           "HI_LIKE"
            dispatch "room-post-koromaru-seasonal.yml" "KO_SEASONAL"
            exit 0
          fi

          # === 13:00 ===
          if [ "$SLOT" = "13:00" ]; then
            dispatch "auto-follow-hiimaru.yml"         "HI_FOLLOW"
            dispatch "auto-follow-koromaru.yml"        "KO_FOLLOW"
            exit 0
          fi

          # 13:30 / 14:00 は空白

          # === 14:30 ===
          if [ "$SLOT" = "14:30" ]; then
            dispatch "auto-like-hiimaru.yml"           "HI_LIKE"
            exit 0
          fi

          # === 15:00 ===
          if [ "$SLOT" = "15:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_DIET"
            exit 0
          fi

          # === 15:30 ===
          if [ "$SLOT" = "15:30" ]; then
            dispatch "room-post-koromaru.yml"          "KO_DIET"
            exit 0
          fi

          # === 17:00 ===
          if [ "$SLOT" = "17:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_KIDS"
            exit 0
          fi

          # === 17:30 ===
          if [ "$SLOT" = "17:30" ]; then
            dispatch "auto-like-hiimaru.yml"           "HI_LIKE"
            dispatch "room-post-koromaru.yml"          "KO_KIDS"
            exit 0
          fi

          # === 18:00 ===
          if [ "$SLOT" = "18:00" ]; then
            dispatch "auto-follow-hiimaru.yml"         "HI_FOLLOW"
            dispatch "auto-follow-koromaru.yml"        "KO_FOLLOW"
            exit 0
          fi

          # === 18:30 ===
          if [ "$SLOT" = "18:30" ]; then
            dispatch "room-post-koromaru.yml"          "KO_SWEETS"
            exit 0
          fi

          # === 19:00 ===
          if [ "$SLOT" = "19:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_JEWELRY"
            exit 0
          fi

          # === 19:30 ===
          if [ "$SLOT" = "19:30" ]; then
            dispatch "room-post-koromaru.yml"          "KO_JEWELRY_BAG"
            exit 0
          fi

          # === 20:00 ===
          if [ "$SLOT" = "20:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_FASHION"
            exit 0
          fi

          # === 20:30 ===
          if [ "$SLOT" = "20:30" ]; then
            dispatch "room-post-koromaru.yml"          "KO_PET"
            exit 0
          fi

          # === 21:00 ===
          if [ "$SLOT" = "21:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_BAG"
            dispatch "auto-like-koromaru.yml"          "KO_LIKE"
            exit 0
          fi

          # === 21:30 ===
          if [ "$SLOT" = "21:30" ]; then
            dispatch "room-post-koromaru.yml"          "KO_INNER"
            exit 0
          fi

          # === 22:00 ===
          if [ "$SLOT" = "22:00" ]; then
            dispatch "room-post-hiimaru.yml"           "HI_BEAUTY"
            dispatch "auto-like-koromaru.yml"          "KO_LIKE"
            exit 0
          fi

          # === 22:30 ===
          if [ "$SLOT" = "22:30" ]; then
            dispatch "room-post-koromaru.yml"          "KO_BEAUTY"
            exit 0
          fi

          echo "No job for slot $SLOT"
