name: dispatcher

on:
  # cron-job.org から叩くのはこれだけ
  workflow_dispatch:

jobs:
  compute-time-slot:
    runs-on: ubuntu-latest
    outputs:
      time_slot: ${{ steps.time.outputs.time_slot }}
      jst_now: ${{ steps.time.outputs.jst_now }}
    steps:
      - name: Compute JST time slot (30min unit)
        id: time
        run: |
          # ランナーは UTC なので、Asia/Tokyo にして現在時刻を取得
          export TZ=Asia/Tokyo
          H=$(date +'%H')
          M=$(date +'%M')

          # 00〜29分 → :00 スロット、30〜59分 → :30 スロット
          if [ "$M" -lt 30 ]; then
            SLOT_MIN="00"
          else
            SLOT_MIN="30"
          fi

          # 先頭の 0 は削る（"06:00" → "6:00" にしたい）
          H_NOZERO=$(echo "$H" | sed 's/^0//')

          SLOT="${H_NOZERO}:${SLOT_MIN}"

          echo "time_slot=$SLOT" >> "$GITHUB_OUTPUT"
          echo "jst_now=${H}:${M}" >> "$GITHUB_OUTPUT"

          echo "JST now = ${H}:${M}"
          echo "Time slot = ${SLOT}"
          
  dispatch-jobs:
    needs: compute-time-slot
    runs-on: ubuntu-latest
    steps:
      - name: Decide and dispatch workflows
        env:
          SLOT: ${{ needs.compute-time-slot.outputs.time_slot }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Time slot = $SLOT"

          dispatch() {
            local workflow_file="$1"
            echo "  -> dispatch $workflow_file"
            curl -sS -X POST \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d '{"ref":"main"}' \
              "https://api.github.com/repos/hiimaru-dev/room-automation/actions/workflows/${workflow_file}/dispatches"
          }

          # === 6:00 JST ===
          if [ "$SLOT" = "6:00" ]; then
            echo "Dispatching for 6:00 (H: Xポスト / K: フォロー①)"
            dispatch "x-beauty-post-hiimaru.yml"      # ひーまる Xポスト
            dispatch "auto-follow-koromaru.yml"       # ころまる フォロー①
            exit 0
          fi

          # === 6:30 JST ===
          if [ "$SLOT" = "6:30" ]; then
            echo "Dispatching for 6:30 (H: フォロー① / K: いいね①)"
            dispatch "auto-follow-hiimaru.yml"        # ひーまる フォロー①
            dispatch "auto-like-koromaru.yml"         # ころまる いいね①
            exit 0
          fi

          # === 7:00 JST ===
          if [ "$SLOT" = "7:00" ]; then
            echo "Dispatching for 7:00 (H: 美容コスメ① / K: フォロー②)"
            dispatch "room-post-hiimaru.yml"          # ひーまる 美容コスメ①
            dispatch "auto-follow-koromaru.yml"       # ころまる フォロー②（同じWFでOK）
            exit 0
          fi

          # === 7:30 JST ===
          if [ "$SLOT" = "7:30" ]; then
            echo "Dispatching for 7:30 (H: いいね① / K: 美容コスメ①)"
            dispatch "auto-like-hiimaru.yml"          # ひーまる いいね①
            dispatch "room-post-koromaru.yml"         # ころまる 美容コスメ①
            exit 0
          fi

          # === 8:00 JST ===
          if [ "$SLOT" = "8:00" ]; then
            echo "Dispatching for 8:00 (H: ダイエット① / K: フォロー③)"
            dispatch "room-post-hiimaru.yml"          # ひーまる ダイエット①
            dispatch "auto-follow-koromaru.yml"       # ころまる フォロー③
            exit 0
          fi

          # === 8:30 JST ===
          if [ "$SLOT" = "8:30" ]; then
            echo "Dispatching for 8:30 (H: フォロー② / K: ダイエット①)"
            dispatch "auto-follow-hiimaru.yml"        # ひーまる フォロー②
            dispatch "room-post-koromaru.yml"         # ころまる ダイエット①
            exit 0
          fi

          echo "No job for slot $SLOT"
  
