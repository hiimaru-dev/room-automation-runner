name: room-post-hiimaru

on:
  workflow_dispatch:
  schedule:
    # 07:00 JST „ÉÄ„Ç§„Ç®„ÉÉ„ÉàÂÅ•Â∫∑‚ë†
    - cron: '0 22 * * *'
    # 09:00 JST „Ç§„É≥„Éä„Éº‰∏ãÁùÄ
    - cron: '0 0 * * *'
    # 11:00 JST „Ç≠„ÉÉ„Ç∫„Éô„Éì„Éº‚ë†
    - cron: '0 2 * * *'
    # 12:00 JST Ê∞¥„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ
    - cron: '0 3 * * *'
    # 13:00 JST ÁæéÂÆπ„Ç≥„Çπ„É°‚ë†
    - cron: '0 4 * * *'
    # 15:00 JST „ÉÄ„Ç§„Ç®„ÉÉ„ÉàÂÅ•Â∫∑‚ë°
    - cron: '0 6 * * *'
    # 17:00 JST „Ç≠„ÉÉ„Ç∫„Éô„Éì„Éº‚ë°
    - cron: '0 8 * * *'
    # 19:00 JST „Ç∏„É•„Ç®„É™„Éº
    - cron: '0 10 * * *'
    # 20:00 JST „É¨„Éá„Ç£„Éº„Çπ„Éï„Ç°„ÉÉ„Ç∑„Éß„É≥
    - cron: '0 11 * * *'
    # 21:00 JST „Éê„ÉÉ„Ç∞
    - cron: '0 12 * * *'
    # 22:00 JST ÁæéÂÆπ„Ç≥„Çπ„É°‚ë°
    - cron: '0 13 * * *'

jobs:
  run-room-post:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      # 1) runner „É™„ÉùËá™‰Ωì„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      - name: Checkout runner repo
        uses: actions/checkout@v4

      # 2) PAT „Çí‰Ωø„Å£„Å¶ private room-automation „Çí clone
      - name: Clone private room-automation
        run: |
          git clone https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      # 3) Node.js 22 + npm „Ç≠„É£„ÉÉ„Ç∑„É•
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: room-automation/package-lock.json

      # 3.5) node_modules „Çí„Ç≠„É£„ÉÉ„Ç∑„É•
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: room-automation/node_modules
          key: ${{ runner.os }}-node-22-${{ hashFiles('room-automation/package-lock.json') }}

      # 3.7) Cache Puppeteer browser (Chrome)
      - name: Cache Puppeteer browser
        id: cache-puppeteer
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('room-automation/package-lock.json') }}

      # 3.8) Install Chrome for Puppeteer if cache miss
      - name: Install Chrome for Puppeteer (if needed)
        if: steps.cache-puppeteer.outputs.cache-hit != 'true'
        run: |
          cd room-automation
          npx puppeteer browsers install chrome

      # 4) .env.hiimaru „Çí Secret „Åã„ÇâÁîüÊàê
      - name: Create .env.hiimaru from secret
        run: |
          cd room-automation
          printf '%s\n' "${{ secrets.ENV_HIIMARU }}" > .env.hiimaru

      # 5) ‰æùÂ≠ò„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
      - name: Install dependencies
        run: |
          cd room-automation
          if [ -d node_modules ]; then
            echo "‚úÖ node_modules cache found ‚Üí npm install „Çπ„Ç≠„ÉÉ„Éó"
          else
            echo "‚¨áÔ∏è node_modules cache „Å™„Åó ‚Üí npm install ÂÆüË°å"
            npm install
          fi
          
      # 6) room-post „ÇíÂÆüË°åÔºà„Å≤„Éº„Åæ„Çã / ÊôÇÈñì„Éô„Éº„Çπ„Åß„Ç∏„É£„É≥„É´Ê±∫ÂÆöÔºâ
      - name: Run room-post (hiimaru / time-based genre)
        run: |
          cd room-automation

          # „Ç®„É©„Éº„Åß„ÇÇ‰∏ÄÊó¶Ê≠¢„ÇÅ„Å™„ÅÑ
          set +e
          npx ts-node -r dotenv/config src/services/room-post/index.ts
          EXIT_CODE=$?

          echo "room-post exited with code ${EXIT_CODE}"

          # 0 „Å® 2 „ÅØÊàêÂäüÊâ±„ÅÑ
          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "2" ]; then
            echo "room-post failed (exit code=${EXIT_CODE})"
            exit "$EXIT_CODE"
          fi
        env:
          NODE_ENV: production
          DOTENV_CONFIG_PATH: .env.hiimaru
          ROOM_TIME_CRON: ${{ github.event.schedule }}  # ‚òÖËøΩÂä†

      # 7) ÂÆüË°åÂæå„Å´ JSON „É≠„Ç∞„Å†„Åë„Çí private repo „Å´ commit & push
      - name: Commit & push JSON logs
        run: |
          cd room-automation

          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git

          # x-beauty-post „ÅÆ tips Á≥ª
          if ls src/services/x-beauty-post/data/*.json >/dev/null 2>&1; then
            git add src/services/x-beauty-post/data/*.json
          fi

          # last_room_id.json
          if [ -f src/services/room-post/data/last_room_id.json ]; then
            git add src/services/room-post/data/last_room_id.json
          fi

          # posted-hiimaru / posted-koromaru
          if [ -f session/posted-hiimaru.json ]; then
            git add -f session/posted-hiimaru.json
          fi
          if [ -f session/posted-koromaru.json ]; then
            git add -f session/posted-koromaru.json
          fi

          # üîê ÊöóÂè∑Âåñ„ÇØ„ÉÉ„Ç≠„ÉºÔºàhiimaru / koromaru ÂÖ±ÈÄö„ÅßÊãæ„ÅÜÔºâ
          if ls session/rakuten_cookie_*.enc >/dev/null 2>&1; then
            git add -f session/rakuten_cookie_*.enc
          fi

          # ‰Ωï„ÇÇÂ§âÂåñ„Åå„Å™„Åë„Çå„Å∞ÁµÇ„Çè„Çä
          if git diff --cached --quiet; then
            echo "No JSON/COOKIE changes to commit."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git commit -m "chore: update runtime json logs (hiimaru)"
          git push origin main
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
