name: auto-follow-hiimaru

concurrency:
  group: room-automation-hiimaru
  cancel-in-progress: false

on:
  workflow_dispatch:
  # schedule:
    # 06:30 JST フォロー①
    # - cron: "30 21 * * *"
    # 08:30 JST フォロー②
    # - cron: "30 23 * * *"
    # 10:30 JST フォロー③
    # - cron: "30 1 * * *"
    # 11:30 JST フォロー④
    # - cron: "30 2 * * *"
    # 13:00 JST フォロー⑤
    # - cron: "0 4 * * *"
    # 18:00 JST フォロー⑥
    # - cron: "0 9 * * *"

jobs:
  run-auto-follow:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout runner repo
        uses: actions/checkout@v4

      - name: Clone private room-automation
        run: |
          git clone https://x-access-token:${GH_PAT}@github.com/hiimaru-dev/room-automation.git
        env:
          GH_PAT: ${{ secrets.GH_PAT }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: room-automation/package-lock.json

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: room-automation/node_modules
          key: ${{ runner.os }}-node-22-${{ hashFiles('room-automation/package-lock.json') }}

      - name: Cache Puppeteer browser
        id: cache-puppeteer
        uses: actions/cache@v4
        with:
          path: ~/.cache/puppeteer
          key: ${{ runner.os }}-puppeteer-${{ hashFiles('room-automation/package-lock.json') }}

      - name: Install Chrome for Puppeteer (if needed)
        if: steps.cache-puppeteer.outputs.cache-hit != 'true'
        run: |
          cd room-automation
          npx puppeteer browsers install chrome

      - name: Create .env.hiimaru from secret
        run: |
          cd room-automation
          printf '%s\n' "${{ secrets.ENV_HIIMARU }}" > .env.hiimaru

      - name: Install dependencies
        run: |
          cd room-automation
          if [ -d node_modules ]; then
            echo "✅ node_modules cache found → npm install スキップ"
          else
            echo "⬇️ node_modules cache なし → npm install 実行"
            npm install
          fi

      - name: Run auto-follow (hiimaru)
        run: |
          cd room-automation
          set +e

          echo "▶ auto-follow START (hiimaru)"
          npx ts-node -r dotenv/config src/services/auto-follow/index.ts
          EXIT_CODE=$?
          echo "auto-follow exited with code ${EXIT_CODE}"

          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "2" ]; then
            echo "auto-follow failed (exit code=${EXIT_CODE})"
            exit "$EXIT_CODE"
          fi
        env:
          NODE_ENV: production
          DOTENV_CONFIG_PATH: .env.hiimaru
